# 发布 SnakeTail：在打 tag 时构建并创建 GitHub Release，上传 exe 与 msi 安装包
name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 WiX Toolset
        run: choco install wixtoolset -y
        shell: pwsh

      - name: 构建 SnakeTail
        run: |
          msbuild SnakeTail\SnakeTail.csproj /p:Configuration=Release;Platform=AnyCPU /t:Clean;Rebuild
        shell: pwsh

      - name: 构建 WiX 安装包 (x86)
        run: |
          msbuild SnakeTail.Wix\SnakeTail.Wix.wixproj /p:Configuration=Release;Platform=AnyCPU;TargetPlatform=x86
        shell: pwsh

      - name: 构建 WiX 安装包 (x64)
        run: |
          msbuild SnakeTail.Wix\SnakeTail.Wix.wixproj /p:Configuration=Release;Platform=AnyCPU;TargetPlatform=x64
        shell: pwsh

      - name: 打包发布产物
        run: |
          $version = if ($env:GITHUB_REF -match 'refs/tags/v(.+)') { $Matches[1] } else { (Get-Date -Format 'yyyy.MM.dd.HHmm') }
          New-Item -ItemType Directory -Force -Path publish
          Copy-Item SnakeTail\bin\Release\net20\* publish\ -Recurse -Force
          Copy-Item SnakeTail.Wix\bin\Release\x86\*.msi publish\ -Force
          Copy-Item SnakeTail.Wix\bin\Release\x64\*.msi publish\ -Force
          Compress-Archive -Path publish\* -DestinationPath "SnakeTail-$version.zip" -Force
          echo "VERSION=$version" >> $env:GITHUB_ENV
        shell: pwsh

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: SnakeTail-build
          path: |
            SnakeTail-*.zip
            SnakeTail.Wix/bin/Release/x86/*.msi
            SnakeTail.Wix/bin/Release/x64/*.msi
          if-no-files-found: error

      - name: 创建 GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            SnakeTail-*.zip
            SnakeTail.Wix/bin/Release/x86/*.msi
            SnakeTail.Wix/bin/Release/x64/*.msi
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
